<?xml version="1.0" encoding="UTF-8" ?>
<div xmlns="http://www.w3.org/1999/xhtml"
     xmlns:py="http://genshi.edgewall.org/"
     xmlns:xi="http://www.w3.org/2001/XInclude"
     py:strip="True">

<div py:def="bookinfo(book)" class="bookinfo">

<?python
import urllib
from genshi import Stream
import rdfob
from viewutils import linked_author, author_name
isbn = book.identifier('urn:isbn:')
asin = book.identifier('urn:asin:')
gbooksid = book.identifier('http://books.google.com/books?id=')
oclcnum = book.identifier('info:oclcnum/')

links = []
title = book['dc:title']
if isinstance(title, Stream):
    title = Markup(title).striptags()
if asin:
    if asin.startswith('2'):
        domain = 'fr'
    elif asin.startswith('3'):
        domain = 'de'
    else:
        domain = 'com'
    links.append(('http://www.amazon.%s/dp/%s/?tag=mishil-20' % (domain, asin), 'Amazon.%s' % domain))
if isinstance(book['dc:title'], Stream) and unicode(book['dc:title'].select('./@lang')) == u'ru':
    links.append(('http://www.ozon.ru/?context=search&text=%s' % urllib.quote(u' '.join([title] + [author_name(c) for c in book.getall('dc:creator')]).encode('cp1251', 'replace'), ''), 'Ozon.ru'))
elif isinstance(book['dc:title'], rdfob.Literal) and book['dc:title'].language == u'ru':
    links.append(('http://www.ozon.ru/?context=search&text=%s' % urllib.quote(u' '.join([title] + [author_name(c) for c in book.getall('dc:creator')]).encode('cp1251', 'replace'), ''), 'Ozon.ru'))
if isbn:
    links.append(('http://openlibrary.org/search?q=isbn_13:%s' % isbn, 'Open Library'))
if gbooksid:
    links.append(('http://books.google.com/books?id=%s' % gbooksid, 'Google Book Search'))
elif isbn:
    links.append(('http://books.google.com/books?vid=ISBN%s' % isbn, 'Google Book Search'))
else:
    links.append(('http://books.google.com/books?q=%s' % urllib.quote(title.encode('utf8'), ''), 'Google Book Search'))
if oclcnum:
    links.append(('http://www.worldcat.org/oclc/%s' % oclcnum, 'WorldCat'))
elif isbn:
    links.append(('http://www.worldcat.org/search?q=isbn:%s' % isbn, 'WorldCat'))
else:
    links.append(('http://www.worldcat.org/search?q=%s' % urllib.quote(title.encode('utf8'), ''), 'WorldCat'))
if isbn:
    links.append(('http://www.librarything.com/isbn/%s' % isbn, 'LibraryThing'))
else:
    links.append(('http://www.librarything.com/title/%s' % urllib.quote(title.encode('utf8'), ''), 'LibraryThing'))
?>

<py:choose>
    <py:when test="book.getone('mhs:coverThumbnail', as_uriref=True, default=None)">
        <p class="cover"><img src="${book.getone('mhs:coverThumbnail', as_uriref=True)}" alt="" /></p>
    </py:when>
    <py:when test="asin">
        <p class="cover"><img src="http://images.amazon.com/images/P/${asin}.01.MZZZZZZZ.jpg" alt="" /></p>
    </py:when>
</py:choose>

<div class="beside">
    <p class="main">
        <em><a py:strip="'mhs:availableFrom' not in book" href="${book.getone('mhs:availableFrom', as_uriref=True)}">${book['dc:title']}</a></em><br />
        <py:if test="book.getall('dc:creator')">by ${Markup(', ').join(linked_author(c) for c in book.getall('dc:creator'))}</py:if>
    </p>
    <p class="publication" py:with="publisher = book.getone('dc:publisher', default=None); date = book.getone('dc:date', default=None)">
        <py:if test="publisher or date">
            Published <py:if test="publisher">by ${publisher}</py:if><py:if test="publisher and date">, </py:if><py:if test="date">${date}</py:if><br />
        </py:if>
        <py:if test="isbn">ISBN ${isbn}</py:if>
    </p>
    <p class="links">Find this book online:<br />
        <py:for each="n, (url, anchor) in enumerate(links)">
            <a href="${url}">${anchor}</a><py:if test="n &lt; len(links) - 1">,</py:if>
        </py:for>
    </p>
</div>

</div>

</div>
