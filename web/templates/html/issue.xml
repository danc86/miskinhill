<?xml version="1.0" encoding="UTF-8" ?>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:py="http://genshi.edgewall.org/"
      xmlns:xi="http://www.w3.org/2001/XInclude"
      lang="en-AU">
<xi:include href="_commonwrapper.xml" />

<?python
from itertools import groupby
from viewutils import striptags, linked_author, sort_by_list, book_summary
import representations
issue = node
journal = issue['mhs:isIssueOf']
?>

<head>
    <title>${journal['dc:title']} Vol. ${issue['mhs:volume']}, Issue ${issue['mhs:issueNumber']}</title>
    <py:for each="r in representations.for_node(node)" py:if="r.format != 'html'">
        ${r(req, node).link()}
    </py:for>
    <link rel="stylesheet" type="text/css" href="/style/issue.css" />
</head>

<body>

${breadcrumbs([('/journals/', 'Journals'), 
               (journal.uri, journal['dc:title'])])}

<h2>
    <span class="journal-title">${journal['dc:title']}</span>
    <span class="issue">Vol. ${issue['mhs:volume']}, Issue ${issue['mhs:issueNumber']} (${issue['dc:coverage']})</span>
    <abbr class="unapi-id" title="${issue.uri}" />
</h2>

<div class="metabox-container">
    ${searchbox(issue)}

    <div class="issue-meta metabox">
        <h4>Issue details</h4>
        <p class="cover"><img src="${issue.getone('mhs:coverThumbnail', as_uriref=True).uri}" alt="" /></p>
        <p>Published ${issue['mhs:publicationDate'].strftime('%-1d %B %Y')}</p>
        <p class="metadata-links">Metadata:
            ${Markup(u', ').join(r(req, node).anchor() for r in representations.for_node(node) if r.format != 'html')}
        </p>
    </div>
</div>

<py:for each="section, items in groupby(sorted(issue.reflexive('dc:isPartOf', type='mhs:IssueContent'), key=lambda c: c['mhs:startPage']), key=lambda c: c['mhs:inSection'])">
    <h3 id="${unicode(section.uri)[unicode(section.uri).index('#') + 1:]}">${section['mhs:sectionHeading']}</h3>
    <ul class="contents">
        <py:for each="item in items">
            <li>
                <div class="title"><a href="${item.uri}">
                    <py:choose>
                        <py:when test="item.is_any(['mhs:Review'])">${Markup('; ').join(book_summary(b) for b in item.getall('mhs:reviews'))}</py:when>
                        <py:otherwise>${item['dc:title']}</py:otherwise>
                    </py:choose>
                </a></div>
                <div class="author">
                    <py:if test="item.is_any(['mhs:Review'])">Reviewed</py:if> by ${Markup(', ').join(linked_author(a) for a in sort_by_list(item.getall('dc:creator'), list(item.getone('mhs:authorOrder', default=[]))))}
                    <py:if test="'mhs:translator' in item">(translated by <a href="${item['mhs:translator'].uri}">${item['mhs:translator']['foaf:name']}</a>)</py:if>
                </div>
            </li>
        </py:for>
    </ul>
</py:for>

</body>
</html>
