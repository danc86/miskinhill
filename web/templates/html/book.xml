<?xml version="1.0" encoding="UTF-8" ?>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:py="http://genshi.edgewall.org/"
      xmlns:xi="http://www.w3.org/2001/XInclude"
      lang="en-AU">
<xi:include href="_commonwrapper.xml" />
<xi:include href="_bookinfo.xml" />

<?python
import representations
from viewutils import striptags
book = node
citations = set(c['dc:isPartOf'] for c in book.reflexive('mhs:cites'))
reviews = book.reflexive('mhs:reviews')
?>

<head>
    <title>${striptags(book['dc:title'])}</title>
    <py:for each="r in representations.for_node(node)" py:if="r.format != 'html'">
        ${r(req, node).link()}
    </py:for>
    <link rel="stylesheet" type="text/css" href="/style/cited.css" />
</head>

<body>

<h2>Book<abbr class="unapi-id" title="${book.uri}" /></h2>

${bookinfo(book)}

<div class="reviews" py:if="reviews">
    <h3>Reviews</h3>
    <ul class="reviews">
        <li py:for="review in sorted(reviews, key=lambda a: a['dc:isPartOf']['mhs:publicationDate'], reverse=True)"
            py:with="issue = review['dc:isPartOf']; journal = issue['mhs:isIssueOf']">
            <div class="review"><a href="${review.uri}">Review</a> by ${review['dc:creator']['foaf:name']}</div>
            <div class="issue">in <em>${journal['dc:title']}</em> Vol. ${issue['mhs:volume']}, Issue ${issue['mhs:issueNumber']} (${issue['dc:coverage']})</div>
        </li>
    </ul>
</div>

<div class="cited-in" py:if="citations">
    <h3>Cited in</h3>
    <ul class="articles">
        <li py:for="item in sorted(citations, key=lambda a: a['dc:isPartOf']['mhs:publicationDate'], reverse=True)"
            py:with="issue = item['dc:isPartOf']; journal = issue['mhs:isIssueOf']">
            <div class="article"><a href="${item.uri}">
                <py:choose>
                    <py:when test="item.is_any(['mhs:Review'])">Review of ${Markup(' and ').join(Markup('&lt;em&gt;%s&lt;/em&gt;') % striptags(b['dc:title']) for b in item.getall('mhs:reviews'))}</py:when>
                    <py:otherwise>${item['dc:title']}</py:otherwise>
                </py:choose>
            </a></div>
            <div class="issue">in <em>${journal['dc:title']}</em> Vol. ${issue['mhs:volume']}, Issue ${issue['mhs:issueNumber']} (${issue['dc:coverage']})</div>
        </li>
    </ul>
</div>

</body>
</html>
